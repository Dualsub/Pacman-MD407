/*
 * 	startup.c
 *
 */
 
 #include "graphics.h"
 #include "delay.h"
 #include "keypad.h"
 #include "object.h"
 #include "pacman.h"
 #include "ghost.h"
 
__attribute__((naked)) __attribute__((section (".start_section")) )
void startup ( void )
{
__asm__ volatile(" LDR R0,=0x2001C000\n");		/* set stack */
__asm__ volatile(" MOV SP,R0\n");
__asm__ volatile(" BL main\n");					/* call main */
__asm__ volatile(".L1: B .L1\n");				/* never return */
}

#define NUM_WALLS 56

void main(void)
{
    graphics_init();
    keypad_init();
    
    ascii_display("       PACMAN", 1);
    
	GEOMERTY pacman_sprite = { 
	16, 
	5, 5,
	{{2,0}, {3,0}, {4,0}, {1,1}, {5,1}, {0,2}, {0,3}, {0,4}, {6,2}, {6,3}, {6,4}, {1,5}, {5,5}, {2,6}, {3,6}, {4,6}}
	};
	
    GEOMERTY ghost_sprite = {
    24,
    5,5,
    {
    {2,0},{3,0},{4,0},{1,1},{5,1},{0,2},{0,3},{0,4},{0,5},{0,6},{6,2},{6,3},{6,4},{6,5},{6,6},{1,5},{2,5},{3,5},{4,5},{5,5},{2,6},{4,6},{2,3},{4,3}
    }
    };

	OBJECT ghost = { 
	&ghost_sprite, 
	{
    {2,0},{3,0},{4,0},{1,1},{5,1},{0,2},{0,3},{0,4},{0,5},{0,6},{6,2},{6,3},{6,4},{6,5},{6,6},{1,5},{2,5},{3,5},{4,5},{5,5},{2,6},{4,6},{2,3},{4,3}
    },
	1, 0,
	56, 28,
	ghost_draw,
	clear_object,
	ghost_move,
	set_object_speed
	};
	
	OBJECT ghost2 = { 
	&ghost_sprite, 
	{
    {2,0},{3,0},{4,0},{1,1},{5,1},{0,2},{0,3},{0,4},{0,5},{0,6},{6,2},{6,3},{6,4},{6,5},{6,6},{1,5},{2,5},{3,5},{4,5},{5,5},{2,6},{4,6},{2,3},{4,3}
    },
	1, 0,
	42, 2,
	ghost_draw,
	clear_object,
	ghost_move,
	set_object_speed
	};
	
	OBJECT pacman = { 
		&pacman_sprite, 
		{{2,0}, {3,0}, {4,0}, {1,1}, {5,1}, {0,2}, {0,3}, {0,4}, {6,2}, {6,3}, {6,4}, {1,5}, {5,5}, {2,6}, {3,6}, {4,6}},
		0, 0,
		56, 42,
		pacman_draw,
		clear_object,
		pacman_move,
		set_object_speed
		};
    
	POINT level[NUM_WALLS] = {
/*		{2,2},
		{2,3},
		{2,4},
		{2,5}
*/	{4,0},
	{13,0},
	{1,1},
	{2,1},
	{4,1},
	{6,1},
	{7,1},
	{8,1},
	{9,1},
	{10,1},
	{11,1},
	{13,1},
	{15,1},
	{16,1},
	{1,2},
	{16,2},
	{1,3},
	{3,3},
	{4,3},
	{6,3},
	{7,3},
	{10,3},
	{11,3},
	{13,3},
	{14,3},
	{16,3},
	{6,4},
	{11,4},
	{1,5},
	{3,5},
	{4,5},
	{6,5},
	{7,5},
	{8,5},
	{9,5},
	{10,5},
	{11,5},
	{13,5},
	{14,5},
	{16,5},
	{1,6},
	{16,6},
	{1,7},
	{2,7},
	{4,7},
	{6,7},
	{7,7},
	{8,7},
	{9,7},
	{10,7},
	{11,7},
	{13,7},
	{15,7},
	{16,7},
	{4,8},
	{13,8}
};
	
	POINT map_sprite[1098] = 
	{
	{0,0},
	{1,0},
	{2,0},
	{3,0},
	{4,0},
	{5,0},
	{6,0},
	{7,0},
	{8,0},
	{9,0},
	{10,0},
	{11,0},
	{12,0},
	{13,0},
	{14,0},
	{15,0},
	{16,0},
	{17,0},
	{18,0},
	{19,0},
	{20,0},
	{21,0},
	{22,0},
	{23,0},
	{24,0},
	{25,0},
	{26,0},
	{27,0},
	{28,0},
	{34,0},
	{35,0},
	{36,0},
	{37,0},
	{38,0},
	{39,0},
	{40,0},
	{41,0},
	{42,0},
	{43,0},
	{44,0},
	{45,0},
	{46,0},
	{47,0},
	{48,0},
	{49,0},
	{50,0},
	{51,0},
	{52,0},
	{53,0},
	{54,0},
	{55,0},
	{56,0},
	{57,0},
	{58,0},
	{59,0},
	{60,0},
	{61,0},
	{62,0},
	{63,0},
	{64,0},
	{65,0},
	{66,0},
	{67,0},
	{68,0},
	{69,0},
	{70,0},
	{71,0},
	{72,0},
	{73,0},
	{74,0},
	{75,0},
	{76,0},
	{77,0},
	{78,0},
	{79,0},
	{80,0},
	{81,0},
	{82,0},
	{83,0},
	{84,0},
	{85,0},
	{86,0},
	{87,0},
	{88,0},
	{89,0},
	{90,0},
	{91,0},
	{97,0},
	{98,0},
	{99,0},
	{100,0},
	{101,0},
	{102,0},
	{103,0},
	{104,0},
	{105,0},
	{106,0},
	{107,0},
	{108,0},
	{109,0},
	{110,0},
	{111,0},
	{112,0},
	{113,0},
	{114,0},
	{115,0},
	{116,0},
	{117,0},
	{118,0},
	{119,0},
	{120,0},
	{121,0},
	{122,0},
	{123,0},
	{124,0},
	{125,0},
	{126,0},
	{127,0},
	{0,1},
	{29,1},
	{33,1},
	{92,1},
	{96,1},
	{127,1},
	{0,2},
	{29,2},
	{33,2},
	{92,2},
	{96,2},
	{127,2},
	{0,3},
	{29,3},
	{33,3},
	{92,3},
	{96,3},
	{127,3},
	{0,4},
	{29,4},
	{33,4},
	{92,4},
	{96,4},
	{127,4},
	{0,5},
	{29,5},
	{33,5},
	{92,5},
	{96,5},
	{127,5},
	{0,6},
	{29,6},
	{33,6},
	{92,6},
	{96,6},
	{127,6},
	{0,7},
	{29,7},
	{33,7},
	{92,7},
	{96,7},
	{127,7},
	{0,8},
	{10,8},
	{11,8},
	{12,8},
	{13,8},
	{14,8},
	{15,8},
	{16,8},
	{17,8},
	{18,8},
	{29,8},
	{33,8},
	{44,8},
	{45,8},
	{46,8},
	{47,8},
	{48,8},
	{49,8},
	{50,8},
	{51,8},
	{52,8},
	{53,8},
	{54,8},
	{55,8},
	{56,8},
	{57,8},
	{58,8},
	{59,8},
	{60,8},
	{61,8},
	{62,8},
	{63,8},
	{64,8},
	{65,8},
	{66,8},
	{67,8},
	{68,8},
	{69,8},
	{70,8},
	{71,8},
	{72,8},
	{73,8},
	{74,8},
	{75,8},
	{76,8},
	{77,8},
	{78,8},
	{79,8},
	{80,8},
	{81,8},
	{92,8},
	{96,8},
	{107,8},
	{108,8},
	{109,8},
	{110,8},
	{111,8},
	{112,8},
	{113,8},
	{114,8},
	{115,8},
	{127,8},
	{0,9},
	{9,9},
	{19,9},
	{29,9},
	{33,9},
	{43,9},
	{82,9},
	{92,9},
	{96,9},
	{106,9},
	{116,9},
	{127,9},
	{0,10},
	{8,10},
	{19,10},
	{29,10},
	{33,10},
	{43,10},
	{82,10},
	{92,10},
	{96,10},
	{106,10},
	{117,10},
	{127,10},
	{0,11},
	{8,11},
	{19,11},
	{29,11},
	{33,11},
	{43,11},
	{82,11},
	{92,11},
	{96,11},
	{106,11},
	{117,11},
	{127,11},
	{0,12},
	{8,12},
	{12,12},
	{13,12},
	{14,12},
	{15,12},
	{16,12},
	{17,12},
	{18,12},
	{30,12},
	{31,12},
	{32,12},
	{44,12},
	{45,12},
	{46,12},
	{47,12},
	{48,12},
	{49,12},
	{50,12},
	{51,12},
	{52,12},
	{53,12},
	{54,12},
	{55,12},
	{56,12},
	{57,12},
	{58,12},
	{59,12},
	{60,12},
	{61,12},
	{62,12},
	{63,12},
	{64,12},
	{65,12},
	{66,12},
	{67,12},
	{68,12},
	{69,12},
	{70,12},
	{71,12},
	{72,12},
	{73,12},
	{74,12},
	{75,12},
	{76,12},
	{77,12},
	{78,12},
	{79,12},
	{80,12},
	{81,12},
	{93,12},
	{94,12},
	{95,12},
	{107,12},
	{108,12},
	{109,12},
	{110,12},
	{111,12},
	{112,12},
	{113,12},
	{117,12},
	{127,12},
	{0,13},
	{8,13},
	{12,13},
	{113,13},
	{117,13},
	{127,13},
	{0,14},
	{8,14},
	{12,14},
	{113,14},
	{117,14},
	{127,14},
	{0,15},
	{8,15},
	{12,15},
	{113,15},
	{117,15},
	{127,15},
	{0,16},
	{8,16},
	{12,16},
	{113,16},
	{117,16},
	{127,16},
	{0,17},
	{8,17},
	{12,17},
	{113,17},
	{117,17},
	{127,17},
	{0,18},
	{8,18},
	{12,18},
	{113,18},
	{117,18},
	{127,18},
	{0,19},
	{8,19},
	{12,19},
	{113,19},
	{117,19},
	{127,19},
	{0,20},
	{8,20},
	{12,20},
	{113,20},
	{117,20},
	{127,20},
	{0,21},
	{8,21},
	{12,21},
	{113,21},
	{117,21},
	{127,21},
	{0,22},
	{8,22},
	{12,22},
	{23,22},
	{24,22},
	{25,22},
	{26,22},
	{27,22},
	{28,22},
	{29,22},
	{30,22},
	{31,22},
	{32,22},
	{45,22},
	{46,22},
	{47,22},
	{48,22},
	{49,22},
	{50,22},
	{51,22},
	{52,22},
	{53,22},
	{72,22},
	{73,22},
	{74,22},
	{75,22},
	{76,22},
	{77,22},
	{78,22},
	{79,22},
	{80,22},
	{93,22},
	{94,22},
	{95,22},
	{96,22},
	{97,22},
	{98,22},
	{99,22},
	{100,22},
	{101,22},
	{102,22},
	{113,22},
	{117,22},
	{127,22},
	{0,23},
	{8,23},
	{12,23},
	{22,23},
	{33,23},
	{44,23},
	{54,23},
	{71,23},
	{81,23},
	{92,23},
	{103,23},
	{113,23},
	{117,23},
	{127,23},
	{0,24},
	{8,24},
	{12,24},
	{22,24},
	{33,24},
	{43,24},
	{54,24},
	{71,24},
	{82,24},
	{92,24},
	{103,24},
	{113,24},
	{117,24},
	{127,24},
	{0,25},
	{8,25},
	{12,25},
	{22,25},
	{33,25},
	{43,25},
	{54,25},
	{71,25},
	{82,25},
	{92,25},
	{103,25},
	{113,25},
	{117,25},
	{127,25},
	{0,26},
	{9,26},
	{10,26},
	{11,26},
	{23,26},
	{24,26},
	{25,26},
	{26,26},
	{27,26},
	{28,26},
	{29,26},
	{30,26},
	{31,26},
	{32,26},
	{43,26},
	{47,26},
	{48,26},
	{49,26},
	{50,26},
	{51,26},
	{52,26},
	{53,26},
	{72,26},
	{73,26},
	{74,26},
	{75,26},
	{76,26},
	{77,26},
	{78,26},
	{82,26},
	{93,26},
	{94,26},
	{95,26},
	{96,26},
	{97,26},
	{98,26},
	{99,26},
	{100,26},
	{101,26},
	{102,26},
	{114,26},
	{115,26},
	{116,26},
	{127,26},
	{0,27},
	{43,27},
	{47,27},
	{78,27},
	{82,27},
	{127,27},
	{0,28},
	{43,28},
	{47,28},
	{78,28},
	{82,28},
	{127,28},
	{0,29},
	{43,29},
	{47,29},
	{78,29},
	{82,29},
	{127,29},
	{0,30},
	{43,30},
	{47,30},
	{78,30},
	{82,30},
	{127,30},
	{0,31},
	{43,31},
	{47,31},
	{78,31},
	{82,31},
	{127,31},
	{0,32},
	{43,32},
	{47,32},
	{78,32},
	{82,32},
	{127,32},
	{0,33},
	{43,33},
	{47,33},
	{78,33},
	{82,33},
	{127,33},
	{0,34},
	{43,34},
	{47,34},
	{78,34},
	{82,34},
	{127,34},
	{0,35},
	{43,35},
	{47,35},
	{78,35},
	{82,35},
	{127,35},
	{0,36},
	{9,36},
	{10,36},
	{11,36},
	{23,36},
	{24,36},
	{25,36},
	{26,36},
	{27,36},
	{28,36},
	{29,36},
	{30,36},
	{31,36},
	{32,36},
	{43,36},
	{47,36},
	{48,36},
	{49,36},
	{50,36},
	{51,36},
	{52,36},
	{53,36},
	{54,36},
	{55,36},
	{56,36},
	{57,36},
	{58,36},
	{59,36},
	{60,36},
	{61,36},
	{62,36},
	{63,36},
	{64,36},
	{65,36},
	{66,36},
	{67,36},
	{68,36},
	{69,36},
	{70,36},
	{71,36},
	{72,36},
	{73,36},
	{74,36},
	{75,36},
	{76,36},
	{77,36},
	{78,36},
	{82,36},
	{93,36},
	{94,36},
	{95,36},
	{96,36},
	{97,36},
	{98,36},
	{99,36},
	{100,36},
	{101,36},
	{102,36},
	{114,36},
	{115,36},
	{116,36},
	{127,36},
	{0,37},
	{8,37},
	{12,37},
	{22,37},
	{33,37},
	{43,37},
	{82,37},
	{92,37},
	{103,37},
	{113,37},
	{117,37},
	{127,37},
	{0,38},
	{8,38},
	{12,38},
	{22,38},
	{33,38},
	{43,38},
	{82,38},
	{92,38},
	{103,38},
	{113,38},
	{117,38},
	{127,38},
	{0,39},
	{8,39},
	{12,39},
	{22,39},
	{33,39},
	{44,39},
	{81,39},
	{92,39},
	{103,39},
	{113,39},
	{117,39},
	{127,39},
	{0,40},
	{8,40},
	{12,40},
	{23,40},
	{24,40},
	{25,40},
	{26,40},
	{27,40},
	{28,40},
	{29,40},
	{30,40},
	{31,40},
	{32,40},
	{45,40},
	{46,40},
	{47,40},
	{48,40},
	{49,40},
	{50,40},
	{51,40},
	{52,40},
	{53,40},
	{54,40},
	{55,40},
	{56,40},
	{57,40},
	{58,40},
	{59,40},
	{60,40},
	{61,40},
	{62,40},
	{63,40},
	{64,40},
	{65,40},
	{66,40},
	{67,40},
	{68,40},
	{69,40},
	{70,40},
	{71,40},
	{72,40},
	{73,40},
	{74,40},
	{75,40},
	{76,40},
	{77,40},
	{78,40},
	{79,40},
	{80,40},
	{93,40},
	{94,40},
	{95,40},
	{96,40},
	{97,40},
	{98,40},
	{99,40},
	{100,40},
	{101,40},
	{102,40},
	{113,40},
	{117,40},
	{127,40},
	{0,41},
	{8,41},
	{12,41},
	{113,41},
	{117,41},
	{127,41},
	{0,42},
	{8,42},
	{12,42},
	{113,42},
	{117,42},
	{127,42},
	{0,43},
	{8,43},
	{12,43},
	{113,43},
	{117,43},
	{127,43},
	{0,44},
	{8,44},
	{12,44},
	{113,44},
	{117,44},
	{127,44},
	{0,45},
	{8,45},
	{12,45},
	{113,45},
	{117,45},
	{127,45},
	{0,46},
	{8,46},
	{12,46},
	{113,46},
	{117,46},
	{127,46},
	{0,47},
	{8,47},
	{12,47},
	{113,47},
	{117,47},
	{127,47},
	{0,48},
	{8,48},
	{12,48},
	{113,48},
	{117,48},
	{127,48},
	{0,49},
	{8,49},
	{12,49},
	{113,49},
	{117,49},
	{127,49},
	{0,50},
	{8,50},
	{12,50},
	{13,50},
	{14,50},
	{15,50},
	{16,50},
	{17,50},
	{18,50},
	{30,50},
	{31,50},
	{32,50},
	{44,50},
	{45,50},
	{46,50},
	{47,50},
	{48,50},
	{49,50},
	{50,50},
	{51,50},
	{52,50},
	{53,50},
	{54,50},
	{55,50},
	{56,50},
	{57,50},
	{58,50},
	{59,50},
	{60,50},
	{61,50},
	{62,50},
	{63,50},
	{64,50},
	{65,50},
	{66,50},
	{67,50},
	{68,50},
	{69,50},
	{70,50},
	{71,50},
	{72,50},
	{73,50},
	{74,50},
	{75,50},
	{76,50},
	{77,50},
	{78,50},
	{79,50},
	{80,50},
	{81,50},
	{93,50},
	{94,50},
	{95,50},
	{107,50},
	{108,50},
	{109,50},
	{110,50},
	{111,50},
	{112,50},
	{113,50},
	{117,50},
	{127,50},
	{0,51},
	{8,51},
	{19,51},
	{29,51},
	{33,51},
	{43,51},
	{82,51},
	{92,51},
	{96,51},
	{106,51},
	{117,51},
	{127,51},
	{0,52},
	{8,52},
	{19,52},
	{29,52},
	{33,52},
	{43,52},
	{82,52},
	{92,52},
	{96,52},
	{106,52},
	{117,52},
	{127,52},
	{0,53},
	{9,53},
	{19,53},
	{29,53},
	{33,53},
	{43,53},
	{82,53},
	{92,53},
	{96,53},
	{106,53},
	{116,53},
	{127,53},
	{0,54},
	{10,54},
	{11,54},
	{12,54},
	{13,54},
	{14,54},
	{15,54},
	{16,54},
	{17,54},
	{18,54},
	{29,54},
	{33,54},
	{44,54},
	{45,54},
	{46,54},
	{47,54},
	{48,54},
	{49,54},
	{50,54},
	{51,54},
	{52,54},
	{53,54},
	{54,54},
	{55,54},
	{56,54},
	{57,54},
	{58,54},
	{59,54},
	{60,54},
	{61,54},
	{62,54},
	{63,54},
	{64,54},
	{65,54},
	{66,54},
	{67,54},
	{68,54},
	{69,54},
	{70,54},
	{71,54},
	{72,54},
	{73,54},
	{74,54},
	{75,54},
	{76,54},
	{77,54},
	{78,54},
	{79,54},
	{80,54},
	{81,54},
	{92,54},
	{96,54},
	{107,54},
	{108,54},
	{109,54},
	{110,54},
	{111,54},
	{112,54},
	{113,54},
	{114,54},
	{115,54},
	{127,54},
	{0,55},
	{29,55},
	{33,55},
	{92,55},
	{96,55},
	{127,55},
	{0,56},
	{29,56},
	{33,56},
	{92,56},
	{96,56},
	{127,56},
	{0,57},
	{29,57},
	{33,57},
	{92,57},
	{96,57},
	{127,57},
	{0,58},
	{29,58},
	{33,58},
	{92,58},
	{96,58},
	{127,58},
	{0,59},
	{29,59},
	{33,59},
	{92,59},
	{96,59},
	{127,59},
	{0,60},
	{29,60},
	{33,60},
	{92,60},
	{96,60},
	{127,60},
	{0,61},
	{29,61},
	{33,61},
	{92,61},
	{96,61},
	{127,61},
	{0,62},
	{28,62},
	{34,62},
	{91,62},
	{97,62},
	{127,62},
	{0,63},
	{1,63},
	{2,63},
	{3,63},
	{4,63},
	{5,63},
	{6,63},
	{7,63},
	{8,63},
	{9,63},
	{10,63},
	{11,63},
	{12,63},
	{13,63},
	{14,63},
	{15,63},
	{16,63},
	{17,63},
	{18,63},
	{19,63},
	{20,63},
	{21,63},
	{22,63},
	{23,63},
	{24,63},
	{25,63},
	{26,63},
	{27,63},
	{28,63},
	{34,63},
	{35,63},
	{36,63},
	{37,63},
	{38,63},
	{39,63},
	{40,63},
	{41,63},
	{42,63},
	{43,63},
	{44,63},
	{45,63},
	{46,63},
	{47,63},
	{48,63},
	{49,63},
	{50,63},
	{51,63},
	{52,63},
	{53,63},
	{54,63},
	{55,63},
	{56,63},
	{57,63},
	{58,63},
	{59,63},
	{60,63},
	{61,63},
	{62,63},
	{63,63},
	{64,63},
	{65,63},
	{66,63},
	{67,63},
	{68,63},
	{69,63},
	{70,63},
	{71,63},
	{72,63},
	{73,63},
	{74,63},
	{75,63},
	{76,63},
	{77,63},
	{78,63},
	{79,63},
	{80,63},
	{81,63},
	{82,63},
	{83,63},
	{84,63},
	{85,63},
	{86,63},
	{87,63},
	{88,63},
	{89,63},
	{90,63},
	{91,63},
	{97,63},
	{98,63},
	{99,63},
	{100,63},
	{101,63},
	{102,63},
	{103,63},
	{104,63},
	{105,63},
	{106,63},
	{107,63},
	{108,63},
	{109,63},
	{110,63},
	{111,63},
	{112,63},
	{113,63},
	{114,63},
	{115,63},
	{116,63},
	{117,63},
	{118,63},
	{119,63},
	{120,63},
	{121,63},
	{122,63},
	{123,63},
	{124,63},
	{125,63},
	{126,63},
	{127,63}
	};
	
	for(int i = 0; i < 1098; i++)
	{
		graphics_pixel_set(map_sprite[i].x + 1, map_sprite[i].y + 1);
	}
	
	pacman_draw(&pacman);
	
	while(1)
	{
        ghost_move(&ghost, level, NUM_WALLS);
		ghost_move(&ghost2, level, NUM_WALLS);
		pacman_move(&pacman, level, NUM_WALLS);
        if (ghost_pacman_collide(&pacman, &ghost) || ghost_pacman_collide(&pacman, &ghost2))
		{
            // Skriver game over.
            delay_mikro(1000);
            graphics_clear_screen();
            break;
		}
	}
	
	
}

